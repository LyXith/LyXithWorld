package org.lyxith.lyxithworld.command;

import com.mojang.brigadier.arguments.BoolArgumentType;
import com.mojang.brigadier.arguments.StringArgumentType;
import com.mojang.brigadier.context.CommandContext;
import com.mojang.brigadier.tree.LiteralCommandNode;
import net.minecraft.command.argument.IdentifierArgumentType;
import net.minecraft.server.MinecraftServer;
import net.minecraft.server.command.CommandManager;
import net.minecraft.server.command.ServerCommandSource;
import net.minecraft.server.world.ServerWorld;
import net.minecraft.text.Text;
import net.minecraft.util.Identifier;
import net.minecraft.util.math.Vec3d;
import net.minecraft.world.GameRules;
import net.minecraft.world.TeleportTarget;
import org.lyxith.lyxithconfig.api.LyXithConfigAPI;
import org.lyxith.lyxithworld.WorldManager;

import java.util.ArrayList;
import java.util.List;

import static org.lyxith.lyxithworld.LyxithWorld.*;

public class MainCommand {
     static LyXithConfigAPI configAPI = getConfigAPI();
     public static LiteralCommandNode<ServerCommandSource> mainCommand = CommandManager.literal("lyxithworld")
            .executes(context -> {
                configAPI.loadConfig(modId,configName);
                context.getSource().sendFeedback(()->Text.literal(configNode.getNode("helpInfo").get().getString().get()), false);
                return 1;
            }).build();
    public static LiteralCommandNode<ServerCommandSource> alias1 = CommandManager.literal("lw")
            .executes(context -> {
                configAPI.loadConfig(modId,configName);
                context.getSource().sendFeedback(()->Text.literal(configNode.getNode("helpInfo").get().getString().get()), false);
                return 1;
            }).build();
    public static LiteralCommandNode<ServerCommandSource> alias2 = CommandManager.literal("p")
            .executes(context -> {
                configAPI.loadConfig(modId,configName);
                context.getSource().sendFeedback(()->Text.literal(configNode.getNode("helpInfo").get().getString().get()), false);
                return 1;
            }).build();
    public static LiteralCommandNode<ServerCommandSource> createWorld = CommandManager.literal("create")
            .then(CommandManager.argument("DimensionType", StringArgumentType.string())
                    .then(CommandManager.argument("Generator", StringArgumentType.string())
                            .then(CommandManager.argument("ShouldTickTime", BoolArgumentType.bool())
                                    .executes(MainCommand::createWorld)
                                    .then(CommandManager.argument("worldName", StringArgumentType.string())
                                            .executes(MainCommand::createWorld)))))
            .build();
    public static LiteralCommandNode<ServerCommandSource> loadWorld = CommandManager.literal("load")
            .executes(context -> {
                String worldId = context.getSource().getName().toLowerCase();
                try {
                    WorldManager.loadWorld(Identifier.of(nameSpace,worldId));
                } catch (Exception e) {
                    LOGGER.warn(e.getMessage());
                    context.getSource().sendFeedback(() -> Text.literal("Error:"+e.getMessage()),false);
                    return 0;
                }
                context.getSource().sendFeedback(() -> Text.literal(worldId+ " world loaded."),false);
                List<String> worlds = configNode.getNode("worlds").get().getList().get();
                worlds.add(Identifier.of(nameSpace,worldId).toString());
                configNode.initNode("worlds",false,worlds);
                configAPI.saveConfig(modId,configName,configNode);
                return 1;
            })
            .then(CommandManager.argument("worldId", IdentifierArgumentType.identifier())
                    .executes(context -> {
                        try {
                            WorldManager.loadWorld(IdentifierArgumentType.getIdentifier(context,"worldId"));
                        } catch (Exception e) {
                            LOGGER.warn(e.getMessage());
                            context.getSource().sendFeedback(() -> Text.literal("Error:"+e.getMessage()),false);
                            return 0;
                        }
                        context.getSource().sendFeedback(() -> Text.literal(IdentifierArgumentType.getIdentifier(context,"worldId")+ " world loaded."),false);
                        List<String> worlds = configNode.getNode("worlds").get().getList().get();
                        worlds.add(IdentifierArgumentType.getIdentifier(context,"worldId").toString());
                        worlds.set(3,"0");
                        worlds.set(4,"8");
                        worlds.set(5,"0");
                        configNode.initNode("worlds",false,worlds);
                        configAPI.saveConfig(modId,configName,configNode);
                        return 1;
                    })).build();
    public static LiteralCommandNode<ServerCommandSource> unloadWorld = CommandManager.literal("unload")
            .executes(context -> {
                String worldId = context.getSource().getName().toLowerCase();
                try {
                    WorldManager.unloadWorld(Identifier.of(nameSpace,worldId));
                } catch (Exception e) {
                    LOGGER.warn(e.getMessage());
                    context.getSource().sendFeedback(() -> Text.literal("Error:"+e.getMessage()),false);
                    return 0;
                }
                context.getSource().sendFeedback(() -> Text.literal(worldId+ " world unloaded."),false);
                List<String> worlds = configNode.getNode("worlds").get().getList().get();
                worlds.remove(Identifier.of(nameSpace,worldId).toString());
                configNode.initNode("worlds",true,worlds);
                configAPI.saveConfig(modId,configName,configNode);
                return 1;
            })
            .then(CommandManager.argument("worldId", IdentifierArgumentType.identifier())
                    .executes(context -> {
                        try {
                            WorldManager.unloadWorld(IdentifierArgumentType.getIdentifier(context,"worldId"));
                        } catch (Exception e) {
                            LOGGER.warn(e.getMessage());
                            context.getSource().sendFeedback(() -> Text.literal("Error:"+e.getMessage()),false);
                            return 0;
                        }
                        context.getSource().sendFeedback(() -> Text.literal(IdentifierArgumentType.getIdentifier(context,"worldId")+ " world unloaded."),false);
                        List<String> worlds = configNode.getNode("worlds").get().getList().get();
                        worlds.remove(IdentifierArgumentType.getIdentifier(context,"worldId").toString());
                        configNode.initNode("worlds",true,worlds);
                        configAPI.saveConfig(modId,configName,configNode);
                        return 1;
                    })).build();
    public static LiteralCommandNode<ServerCommandSource> delWorld = CommandManager.literal("delete")
            .executes(context -> {
                String worldId = context.getSource().getName().toLowerCase();
                try {
                    WorldManager.delWorld(Identifier.of(nameSpace,worldId));
                } catch (Exception e) {
                    LOGGER.warn(e.getMessage());
                    context.getSource().sendFeedback(() -> Text.literal("Error:"+e.getMessage()),false);
                    return 0;
                }
                context.getSource().sendFeedback(() -> Text.literal(worldId+ " world deleted."),false);
                List<String> worlds = configNode.getNode("worlds").get().getList().get();
                worlds.remove(Identifier.of(nameSpace,worldId).toString());
                configNode.delNode("worldConfigs."+ Identifier.of(nameSpace,worldId));
                configNode.initNode("worlds",true,worlds);
                configAPI.saveConfig(modId,configName,configNode);
                return 1;
            })
            .then(CommandManager.argument("worldId", IdentifierArgumentType.identifier())
                    .executes(context -> {
                        try {
                            WorldManager.delWorld(IdentifierArgumentType.getIdentifier(context,"worldId"));
                        } catch (Exception e) {
                            LOGGER.warn(e.getMessage());
                            context.getSource().sendFeedback(() -> Text.literal("Error:"+e.getMessage()),false);
                            return 0;
                        }
                        context.getSource().sendFeedback(() -> Text.literal(IdentifierArgumentType.getIdentifier(context,"worldId")+ " world deleted."),false);
                        List<String> worlds = configNode.getNode("worlds").get().getList().get();
                        worlds.remove(IdentifierArgumentType.getIdentifier(context,"worldId").toString());
                        configNode.delNode("worldConfigs."+IdentifierArgumentType.getIdentifier(context,"worldId"));
                        configNode.initNode("worlds",true,worlds);
                        configAPI.saveConfig(modId,configName,configNode);
                        return 1;
                    })).build();
    private static int createWorld(CommandContext<ServerCommandSource> context) {
        String dimensionType = StringArgumentType.getString(context, "DimensionType");
        String generator = StringArgumentType.getString(context, "Generator");
        boolean shouldTickTime = BoolArgumentType.getBool(context, "ShouldTickTime");
        String worldName;
        try {
            worldName = StringArgumentType.getString(context, "worldName");
        } catch (IllegalArgumentException e) {
            // å¦æ worldName åæ°ä¸å­å¨ï¼ä½¿ç¨ç©å®¶åç§°
            worldName = context.getSource().getName().toLowerCase();
        }
        Identifier worldId = Identifier.of(nameSpace,worldName);
        if (isWorldExist(worldId)) {
            context.getSource().sendFeedback(() -> Text.literal("You already have a world!"),false);
            return 0;
        }
        String finalWorldName = worldName;
        context.getSource().sendFeedback(() -> Text.literal("World created"+" dimensionType:"+dimensionType+" generator:"+generator+" shouldTickTime:"+shouldTickTime+" worldName:"+ finalWorldName +"."), false);
        WorldManager.createWorld(dimensionType,generator,shouldTickTime,worldName);
        List<String> worldConfig = new ArrayList<>();
        List<String> worlds = configNode.getNode("worlds").get().getList().get();
        worldConfig.add(dimensionType);
        worldConfig.add(generator);
        worldConfig.add(String.valueOf(shouldTickTime));
        configNode.initNode("worldConfigs."+worldId,false,worldConfig);
        worlds.add(worldId.toString());
        configNode.initNode("worlds",false,worlds);
        configAPI.saveConfig(modId,configName,configNode);
        return 1;
    }
    public static LiteralCommandNode<ServerCommandSource> worldGamerule = CommandManager.literal("gamerule")
            .executes(context -> {
                context.getSource().sendFeedback(()-> Text.literal("/lw gamerule list \n /lw gamerule query \n /lw gamerule set"),false);
                return 1;
            }).build();
    public static LiteralCommandNode<ServerCommandSource> wgList = CommandManager.literal("list")
            .executes(context -> {
                ServerWorld world = context.getSource().getWorld();
                GameRules gameRules = world.getGameRules();
                gameRules.accept(new GameRules.Visitor() {
                    @Override
                    public <T extends GameRules.Rule<T>> void visit(GameRules.Key<T> key, GameRules.Type<T> type) {
                        GameRules.Rule<T> rule = gameRules.get(key);
                        String value = rule.serialize();

                        context.getSource().sendFeedback(() -> Text.literal("Â§6" + key.getName() + "Â§7: Â§a" + value),false);
                    }
                });
                return 1;
            }).build();
    public static LiteralCommandNode<ServerCommandSource> wgQuery = CommandManager.literal("query")
            .then(CommandManager.argument("gamerule",StringArgumentType.string())
                    .suggests(GameRuleSuggestionProvider::getSuggestions)
                    .executes(context -> {
                        ServerWorld world = context.getSource().getWorld();
                        GameRules gameRules = world.getGameRules();
                        String inputRuleName = StringArgumentType.getString(context, "gamerule");

                        // æ¥æ¾å¹éçæ¸¸æè§åKey
                        final GameRules.Key<?>[] foundKey = new GameRules.Key<?>[1];
                        gameRules.accept(new GameRules.Visitor() {
                            @Override
                            public <T extends GameRules.Rule<T>> void visit(GameRules.Key<T> key, GameRules.Type<T> type) {
                                if (key.getName().equals(inputRuleName)) {
                                    foundKey[0] = key;
                                }
                            }
                        });

                        if (foundKey[0] != null) {
                            // è·åè§åå¼å¹¶åéåé¦
                            GameRules.Rule<?> rule = gameRules.get(foundKey[0]); // ä½¿ç¨getæ¹æ³è·åè§åå¯¹è±¡
                            String value = rule.serialize(); // å°è§åå¼åºååä¸ºå­ç¬¦ä¸²
                            context.getSource().sendFeedback(() -> Text.literal("Â§6"+foundKey[0].getName() + "Â§7: Â§a" + value), false);
                        } else {
                            context.getSource().sendFeedback(() -> Text.literal("Â§cCan't find gameruleÂ§7: Â§a" + inputRuleName), false);
                        }
                        return 1;
                    })).build();
    public static LiteralCommandNode<ServerCommandSource> wgSet = CommandManager.literal("set")
            .then(CommandManager.argument("gamerule", StringArgumentType.string())
                    .suggests(GameRuleSuggestionProvider::getSuggestions)
                    .then(CommandManager.argument("value", StringArgumentType.string())
                            .executes(context -> {
                                ServerWorld world = context.getSource().getWorld();
                                GameRules gameRules = world.getGameRules();
                                String inputRuleName = StringArgumentType.getString(context, "gamerule");
                                String inputValue = StringArgumentType.getString(context, "value");

                                // æ¥æ¾å¹éçæ¸¸æè§åKeyåType
                                final GameRules.Key<?>[] foundKey = new GameRules.Key<?>[1];
                                final GameRules.Type<?>[] foundType = new GameRules.Type<?>[1];

                                gameRules.accept(new GameRules.Visitor() {
                                    @Override
                                    public <T extends GameRules.Rule<T>> void visit(GameRules.Key<T> key, GameRules.Type<T> type) {
                                        if (key.getName().equals(inputRuleName)) {
                                            foundKey[0] = key;
                                            foundType[0] = type;
                                        }
                                    }
                                });

                                if (foundKey[0] != null && foundType[0] != null) {
                                    try {
                                        // è®¾ç½®è§åå¼
                                        GameRules.Rule<?> rule = gameRules.get(foundKey[0]);
                                        boolean success = setRuleValue(rule, inputValue, context.getSource().getServer());

                                        if (success) {
                                            String newValue = rule.serialize();
                                            context.getSource().sendFeedback(() ->
                                                    Text.literal("Â§6" + foundKey[0].getName() + "Â§7 is set to Â§a" + newValue), false);
                                        } else {
                                            context.getSource().sendFeedback(() ->
                                                    Text.literal("Â§cInvalid value: Â§7" + inputValue), false);
                                        }
                                    } catch (Exception e) {
                                        context.getSource().sendFeedback(() ->
                                                Text.literal("Â§cSet failed: Â§7" + e.getMessage()), false);
                                    }
                                } else {
                                    context.getSource().sendFeedback(() ->
                                            Text.literal("Â§cCan't find gamerule: Â§7" + inputRuleName), false);
                                }
                                return 1;
                            }))).build();
    private static boolean setRuleValue(GameRules.Rule<?> rule, String value, MinecraftServer server) {
        try {
            if (rule instanceof GameRules.BooleanRule) {
                if ("true".equalsIgnoreCase(value)) {
                    ((GameRules.BooleanRule) rule).set(true, server);
                    return true;
                } else if ("false".equalsIgnoreCase(value)) {
                    ((GameRules.BooleanRule) rule).set(false, server);
                    return true;
                } else {
                    return false;
                }
            } else if (rule instanceof GameRules.IntRule) {
                int intValue = Integer.parseInt(value);
                ((GameRules.IntRule) rule).set(intValue, server);
                return true;
            }
        } catch (NumberFormatException e) {
            return false;
        }
        return false;
    }
    public static LiteralCommandNode<ServerCommandSource> worldHome = CommandManager.literal("home")
            .executes(context -> {
                ServerCommandSource source = context.getSource();
                ServerWorld world = WorldManager.getWorld(Identifier.of(nameSpace,source.getName().toLowerCase()));
                List worldConfig = configNode.getNode("worldConfigs."+nameSpace+":"+source.getName().toLowerCase()).get().getList().get();
                Vec3d pos = new Vec3d(0,0,0);
                if (worldConfig.size() >= 6 && worldConfig.get(3) instanceof Double && worldConfig.get(4) instanceof Double && worldConfig.get(5) instanceof Double) {
                    pos = new Vec3d(Double.parseDouble(worldConfig.get(3).toString()),
                            Double.parseDouble(worldConfig.get(4).toString()),
                            Double.parseDouble(worldConfig.get(5).toString()));
                } else {
                    source.sendFeedback(()->Text.literal("Â§cSome errors happened "),false);
                }
                if (source.getEntity() != null) {
                    source.sendFeedback(()->Text.literal("Â§6Teleporting to home"),false);
                    source.getEntity().teleportTo(new TeleportTarget(world, pos, Vec3d.ZERO, 0, 0, TeleportTarget.NO_OP));
                }
                return 1;
            }).build();
    public static LiteralCommandNode<ServerCommandSource> worldSetHome = CommandManager.literal("sethome")
            .executes(context -> {
                ServerCommandSource source = context.getSource();
                ServerWorld world = WorldManager.getWorld(Identifier.of(nameSpace,source.getName().toLowerCase()));
                if (!(source.getWorld() == world)) {
                    source.sendFeedback(()->Text.literal("Please sethome in your world"),false);
                    return 0;
                }
                List worldConfig = configNode.getNode("worldConfigs."+nameSpace+":"+source.getName().toLowerCase()).get().getList().get();
                Vec3d pos = source.getPosition();
                worldConfig.set(3,pos.x);
                worldConfig.set(4,pos.y);
                worldConfig.set(5,pos.z);
                configNode.getNode("worldConfigs."+nameSpace+":"+source.getName().toLowerCase()).get().set(worldConfig);
                configAPI.saveConfig(modId,configName,configNode);
                source.sendFeedback(()->Text.literal("Your home is set to "+pos.x+" "+pos.y+" "+pos.z),false);
                return 1;
            }).build();
}
